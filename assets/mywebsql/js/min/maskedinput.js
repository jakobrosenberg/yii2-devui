(function(b){var x=(b.browser.msie?"paste":"input")+".mask",y=void 0!=window.orientation;b.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"}};b.fn.extend({caret:function(d,f){if(0!=this.length){if("number"==typeof d)return f="number"==typeof f?f:d,this.each(function(){if(this.setSelectionRange)this.focus(),this.setSelectionRange(d,f);else if(this.createTextRange){var g=this.createTextRange();g.collapse(!0);g.moveEnd("character",f);g.moveStart("character",d);g.select()}});if(this[0].setSelectionRange)d=
this[0].selectionStart,f=this[0].selectionEnd;else if(document.selection&&document.selection.createRange){var b=document.selection.createRange();d=0-b.duplicate().moveStart("character",-1E5);f=d+b.text.length}return{begin:d,end:f}}},unmask:function(){return this.trigger("unmask")},mask:function(d,f){if(!d&&0<this.length){var n=b(this[0]),g=n.data("tests");return b.map(n.data("buffer"),function(f,b){return g[b]?f:null}).join("")}f=b.extend({placeholder:"_",completed:null},f);var t=b.mask.definitions,
g=[],l=d.length,q=null,k=d.length;b.each(d.split(""),function(f,b){"?"==b?(k--,l=f):t[b]?(g.push(RegExp(t[b])),null==q&&(q=g.length-1)):g.push(null)});return this.each(function(){function p(a){for(;++a<=k&&!g[a];);return a}function n(a){var c=b(this).caret();a=a.keyCode;r=16>a||16<a&&32>a||32<a&&41>a;0!=c.begin-c.end&&(!r||8==a||46==a)&&v(c.begin,c.end);if(8==a||46==a||y&&127==a){for(c=c.begin+(46==a?0:-1);!g[c]&&0<=--c;);for(a=c;a<k;a++)if(g[a]){j[a]=f.placeholder;var e=p(a);if(e<k&&g[a].test(j[e]))j[a]=
j[e];else break}s();h.caret(Math.max(q,c));return!1}if(27==a)return h.val(u),h.caret(0,m()),!1}function z(a){if(r)return r=!1,8==a.keyCode?!1:null;a=a||window.event;var c=a.charCode||a.keyCode||a.which,e=b(this).caret();if(a.ctrlKey||a.altKey||a.metaKey)return!0;if(32<=c&&125>=c||186<c)if(a=p(e.begin-1),a<k&&(c=String.fromCharCode(c),g[a].test(c))){for(var e=a,d=f.placeholder;e<k;e++)if(g[e]){var w=p(e),l=j[e];j[e]=d;if(w<k&&g[w].test(l))d=l;else break}j[a]=c;s();a=p(a);b(this).caret(a);f.completed&&
a==k&&f.completed.call(h)}return!1}function v(a,c){for(var e=a;e<c&&e<k;e++)g[e]&&(j[e]=f.placeholder)}function s(){return h.val(j.join("")).val()}function m(a){for(var c=h.val(),e=-1,b=0,d=0;b<k;b++)if(g[b]){for(j[b]=f.placeholder;d++<c.length;){var m=c.charAt(d-1);if(g[b].test(m)){j[b]=m;e=b;break}}if(d>c.length)break}else j[b]==c[d]&&b!=l&&(d++,e=b);if(!a&&e+1<l)h.val(""),v(0,k);else if(a||e+1>=l)s(),a||h.val(h.val().substring(0,e+1));return l?b:q}var h=b(this),j=b.map(d.split(""),function(a){if("?"!=
a)return t[a]?f.placeholder:a}),r=!1,u=h.val();h.data("buffer",j).data("tests",g);h.attr("readonly")||h.one("unmask",function(){h.unbind(".mask").removeData("buffer").removeData("tests")}).bind("focus.mask",function(){u=h.val();var a=m();s();setTimeout(function(){a==d.length?h.caret(0,a):h.caret(a)},0)}).bind("blur.mask",function(){m();h.val()!=u&&h.change()}).bind("keydown.mask",n).bind("keypress.mask",z).bind(x,function(){setTimeout(function(){h.caret(m(!0))},0)});m()})}})})(jQuery);
